<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ouvir</title>
  <link href="https://fonts.googleapis.com/css2?family=Italiana&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./style/style.css">
  <link rel="icon" href="./../img/icon.jpeg">
</head>
<body>

  <div class="player-container text-center">
    <h1 id="title"></h1>
    <p id="artist"></p>

    <iframe id="youtubePlayer" width="80%" height="500" frameborder="0" allowfullscreen></iframe>
    <br>

    <button class="voltarBtn" onclick="voltar()">‚¨Ö Voltar</button>
  </div>

  <!-- SCRIPT DO SOCKET.IO -->
  <script src="http://localhost:3000/socket.io/socket.io.js"></script>
  <script src="../js/socket.js"></script>

  <script>
    // Fun√ß√£o para voltar
    function voltar() {
      if (document.referrer) {
        window.history.back();
      } else {
        window.location.href = './home.html'; 
      }
    }

    // Pega os par√¢metros da URL
    const params = new URLSearchParams(window.location.search);
    const title = params.get("title");
    const artist = params.get("artist");
    const videoId = params.get("videoId");

    // Verifica se tem dados v√°lidos
    if (!title || !videoId) {
      alert("M√∫sica inv√°lida!");
      window.close();
    } else {
      // Coloca o nome da m√∫sica e artista na tela
      document.getElementById("title").textContent = title;
      document.getElementById("artist").textContent = artist;

      // Coloca o v√≠deo do YouTube no iframe
      document.getElementById("youtubePlayer").src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;

      // üîî ENVIA NOTIFICA√á√ÉO QUANDO O V√çDEO CARREGAR
      enviarNotificacaoMusicaParaAmigos(title);
    }

    // Fun√ß√£o para enviar notifica√ß√£o aos amigos
    function enviarNotificacaoMusicaParaAmigos(tituloMusica) {
      // Pequeno delay para garantir que o socket est√° carregado
      setTimeout(() => {
        if (window.enviarNotificacaoMusica) {
          window.enviarNotificacaoMusica(tituloMusica, window.location.href);
          console.log("üì¢ Notifica√ß√£o enviada para amigos:", tituloMusica);
        } else {
          console.log("‚ö† Aguardando fun√ß√£o de notifica√ß√£o...");
          // Tenta novamente ap√≥s 1 segundo
          setTimeout(() => {
            if (window.enviarNotificacaoMusica) {
              window.enviarNotificacaoMusica(tituloMusica, window.location.href);
              console.log("üì¢ Notifica√ß√£o enviada (segunda tentativa):", tituloMusica);
            } else {
              console.log("‚ùå Fun√ß√£o de notifica√ß√£o n√£o dispon√≠vel");
            }
          }, 1000);
        }
      }, 500);
    }

    // Monitora quando o iframe do YouTube come√ßa a tocar
    function monitorarPlayerYouTube() {
      const iframe = document.getElementById('youtubePlayer');
      
      // Tenta detectar quando o v√≠deo inicia (m√©todo alternativo)
      window.addEventListener('blur', function() {
        // Quando a janela perde foco, pode indicar que o v√≠deo come√ßou
        console.log("üîÑ Verificando se m√∫sica est√° tocando...");
      });
      
      // Tamb√©m envia notifica√ß√£o quando a p√°gina fica vis√≠vel
      document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
          console.log("üìÄ P√°gina vis√≠vel - m√∫sica provavelmente tocando");
        }
      });
    }

    // Inicializa o monitoramento quando a p√°gina carrega
    document.addEventListener('DOMContentLoaded', function() {
      monitorarPlayerYouTube();
      
      // Envia notifica√ß√£o tamb√©m quando o usu√°rio interage com a p√°gina
      document.addEventListener('click', function() {
        const titulo = document.getElementById('title')?.textContent;
        if (titulo && titulo !== 'M√∫sica Desconhecida') {
          console.log("üéµ Intera√ß√£o detectada - verificando notifica√ß√£o");
        }
      });
    });

    // üîÑ FUN√á√ÉO DE TESTE (pode remover depois)
    function testarNotificacao() {
      const tituloTeste = document.getElementById('title')?.textContent || "M√∫sica de Teste";
      if (window.enviarNotificacaoMusica) {
        window.enviarNotificacaoMusica(tituloTeste, window.location.href);
        alert("‚úÖ Notifica√ß√£o de teste enviada!\nVerifique na p√°gina de amigos em outra aba.");
      } else {
        alert("‚ùå Fun√ß√£o de notifica√ß√£o n√£o carregada\nVerifique o console (F12)");
      }
    }
  </script>

  <!-- üîî BOT√ÉO DE TESTE (REMOVA DEPOIS QUE ESTIVER FUNCIONANDO) -->
  <button onclick="testarNotificacao()" style="
    position: fixed; 
    top: 20px; 
    right: 20px; 
    z-index: 1000; 
    background: #ffcd7c; 
    color: #251400; 
    border: none; 
    padding: 10px 15px; 
    border-radius: 20px; 
    cursor: pointer; 
    font-weight: bold;
  ">
    üîî Testar Notifica√ß√£o
  </button>

</body>
</html>